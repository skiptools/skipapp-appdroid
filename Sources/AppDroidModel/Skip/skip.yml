
skip:
  mode: 'kotlin'

build:
  contents:
    - block: 'android'
      export: false
      contents:
        - block: 'sourceSets'
          contents:
            # .build/jni-libs/ is the folder where our toolchain outputs the natively-compiled .so files
            - 'getByName("main").jniLibs.srcDirs(".build/jni-libs")'
        - block: 'packaging'
          contents:
            # keepDebugSymbols is needed to prevent errors like: java.lang.UnsatisfiedLinkError: dlopen failed: empty/missing DT_HASH/DT_GNU_HASH in "/data/app/~~Zoepnr93K9vyUtTUUM0POg==/skip.bridge.samples.test-3nePwd6ioGZtLQ0K0EJpBQ==/base.apk!/lib/arm64-v8a/libdispatch.so" (new hash type from the future?)
            - 'jniLibs.keepDebugSymbols.add("**/*.so")'

    - block: 'tasks.withType<org.gradle.api.tasks.compile.AbstractCompile>'
      export: false
      contents:
        - 'dependsOn("buildSwiftPackage")'

    # compile the module using the native Android toolchain
    - block: 'tasks.register("buildSwiftPackage")'
      export: false
      contents:
        - block: 'doLast'
          contents:
            # need to clear any environment variables that are being set by the iOS toolchain
            # we need to remove any that confuse the toolchain
            - 'System.getenv().toSortedMap().forEach { key, value -> println("${key}=\"${value}\"") }'

            - block: 'exec'
              contents:
                - 'commandLine("sh", "-c", "skip android build -d .build/jni-libs --package-path src/main/swift --product AppDroidModel")'
